{% extends 'base.html' %}
{% load static %}
{% block title %}Home - MoneyParce{% endblock %}

{% block content %}
<div style="padding: 0 60px;">

    {# ---------- SHOW ONLY WHEN LOGGED-IN ---------- #}
    {% if user.is_authenticated %}
    <div style="display: flex; justify-content: space-between; gap: 40px;">

        {# Bar Chart #}
        <div style="text-align: center;">
            <h3>Recent Transactions</h3>
            <div id="bar" style="width: 800px; height: 500px;"></div>
            <button onclick="changeColor('bar')" style="margin-top: 10px;">Change Color</button>
        </div>

        {# Pie Chart #}
        <div style="text-align: center;">
            <h3>Today's Transactions</h3>
            {% if latest_transaction_date and latest_transaction_date == today_date %}
                <div id="pie" style="width: 800px; height: 500px;"></div>
            {% elif latest_transaction_date %}
                <p>No transactions today</p>
            {% else %}
                <p>You havenâ€™t added any expenses yet</p>
            {% endif %}
            <button onclick="changeColor('pie')" style="margin-top: 10px;">Change Color</button>
        </div>
    </div>

    <script type="module">
        import { BarChartStrategy } from "{% static 'js/BarChartStrategy.js' %}";
        import { PieChartStrategy } from "{% static 'js/PieChartStrategy.js' %}";
        import { chart } from "{% static 'js/chart.js' %}";

        const colors = ['color1', 'color2', 'color3', 'color4'];
        const currentColorIndex = { bar: 0, pie: 0 };

        function renderCharts() {
            chart({{ expenses|safe }}, 'Bar Chart', '', new BarChartStrategy(), colors[currentColorIndex.bar]);
            chart({{ expenses|safe }}, 'Pie Chart', '', new PieChartStrategy(), colors[currentColorIndex.pie]);
        }

        window.changeColor = function(type) {
            currentColorIndex[type] = (currentColorIndex[type] + 1) % colors.length;
            let strategy;
            if (type === 'bar') {
                strategy = new BarChartStrategy();
            } else {
                strategy = new PieChartStrategy();
            }
            chart({{ expenses|safe }}, 'Bar Chart', '', strategy, colors[currentColorIndex[type]]);
        };
        // draw only when data exists
        if ({{ expenses|safe }}.length) renderCharts();
    </script>

    {% else %}
        <h2>Welcome to MoneyParce!</h2>
        <p>Please <a href="{% url 'login' %}">log in</a> or
           <a href="{% url 'register' %}">create an account</a> to start tracking
           your income and expenses.</p><br/>
        <div style="">
            <h3 style="text-align: center">Why MoneyParce?</h3>
            <p>Skip the hassle of spreadsheets using MoneyParce, your one-stop, fast, and convenient solution to everyday finance tracking.</p>
            <p>You can track expenses, income, and add budgets all in one place.</p>
            <p>Visual representations of transactions will make interpreting your finances so much easier.</p>
            <p>We've also included a convenient AI assistant to make sense of any complicated financial problems you may come across.</p>
        </div>
    {% endif %}

</div>
{% endblock %}